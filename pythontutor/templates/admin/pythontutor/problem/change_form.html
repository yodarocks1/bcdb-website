{% extends "admin/change_form.html" %}

{% block extrahead %}
{% include "pythontutor/markdown_rendering.html" %}
{{ block.super }}
{% include "pythontutor/monaco.html" %}
{% include "pythontutor/base/head.html" %}
<style type="text/css">
    #content {
        background: rgb(18, 18, 18);
        color: white !important;
    }
    .monaco-tab-selectors {
        background: rgb(18, 18, 18) !important;
    }
    .monaco-tab::after {
        background: rgb(18, 18, 18) !important;
    }
    .deletelink {
        height: fit-content !important;
    }
    .monaco-language-selector, .monaco-main-selector {
        font-size: larger;
    }
    .dynamic-tests td.original p {
        left: -1000px !important;
        text-align: start;
        padding: 0 !important;
        height: 1rem !important;
        width: calc(1000px + 100%);
    }
    .dynamic-tests td.original p a {
        position: absolute;
        left: 1000px !important;
        font-size: 1em !important;
    }
    div.renderarea {
        font-family: var(--bs-body-font-family);
        font-weight: var(--bs-body-font-weight);
        color: var(--bs-body-color);
        background-color: var(--bs-body-bg);
    }
    div.renderarea *:not(code) {
        font-size: var(--bs-body-font-size) !important;
        line-height: var(--bs-body-line-height) !important;
    }
    div.renderarea ul, div.renderarea ol {
        margin-left: 0;
        padding-left: 2rem;
    }
    div.renderarea ul li {
        list-style-type: square;
    }
    .monaco-editor button:not(.btn) {
        vertical-align: text-top;
    }
    label {
        position: relative;
        z-index: 1;
    }
    nav {
        box-sizing: unset;
    }
    #content {
        height: 100%;
    }
    #footer {
        padding: 0;
    }

    /* Fixes for Django 5.0 */
    .aligned label {
        float: left;
	min-width: unset;
    }

</style>
{% endblock %}
{% block footer %}
{{ block.super }}
{% include "pythontutor/base/foot.html" %}
<script type="text/javascript">
    class ChangeProblemProvider extends Provider {
        constructor(renderArea) {
            super();
            this.renderArea = renderArea;
        }
        test(editorGroup, activeEditor) {
            if (activeEditor.language === "markdown") {
                let html = DOMPurify.sanitize(md.render(activeEditor.code));
                this.renderArea.innerHTML = html;
            } else if (editorGroup.outputEditor) {
                editorGroup.outputEditor.code = "<< Placeholder text >>\nSome level of testing may occur here in the future.\n     or it may not, and the button will be removed.";
                monaco.editor.setModelLanguage(editorGroup.outputEditor.editor.getModel(), "plaintext");
            }
        }
        save(editorGroup, activeEditor) { return false; }
    }
    let dre = document.getElementById("design_requirements-editor");
    let renderArea = document.createElement("div");
    renderArea.classList.add("py-2", "renderarea");
    dre.parentElement.appendChild(renderArea);
    window.provider = new ChangeProblemProvider(renderArea);

    let ll = document.querySelector("select[name='languages']");
    var llOptions = {};
    let llChange = () => {
        let lAdd = []
        let lRemove = Object.keys(llOptions);
        for (let l of ll.selectedOptions) {
            let lCode = allLanguages[l.value].code;
            if (lCode in llOptions) {
                lRemove.splice(lRemove.indexOf(lCode), 1);
            } else {
                lAdd.push(l);
            }
        }
        for (let l of lAdd) {
            let lOption = document.createElement("option");
            let lObj = allLanguages[l.value];
            lOption.value = lObj.code;
            lOption.innerText = lObj.name;
            llOptions[lObj.code] = lOption;
            allEditors['starter_code-editor'].languageSelect.append(lOption);
        }
        for (let lCode of lRemove) {
            llOptions[lCode].remove();
            delete llOptions[lCode];
        }
        allEditors['starter_code-editor'].languageSelect.dispatchEvent(new Event("change"));
    }
    llChange();
    ll.onchange = llChange;

    /* Fixes for Django 5.0 */
    window.addEventListener('load', () => {
        let dr = document.querySelector(".field-design_requirements");
        dr.replaceChild(dr.querySelector("div.flex-container"), dr.querySelector("div"));
        dr.querySelector("div.flex-container").classList.remove("flex-container");
        let sc = document.querySelector(".field-starter_code");
        sc.replaceChild(sc.querySelector("div.flex-container"), sc.querySelector("div"));
        sc.querySelector("div.flex-container").classList.remove("flex-container");
    });
</script>
{% endblock %}

